run-name: Run main workflow by @${{ github.actor }}

on:
    push:
    workflow_dispatch:

env:
    STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
    DATA_PASS: ${{ secrets.DATA_PASS }}
    DATA_USER: ${{ secrets.DATA_USER }}
    DATA_KEY: ${{ secrets.DATA_KEY }}
    NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
    SIB_API_KEY: ${{ secrets.SIB_API_KEY }}
    NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
    OPENAI_API_ORG: ${{ secrets.OPENAI_API_ORG }}
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
    TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

jobs:
    supabase-test:
        env:
            SUPABASE_SCANNER_BUFFER_SIZE: 5mb

        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v3

            - uses: supabase/setup-cli@v1
              with:
                  version: latest

            - name: Verify supabase cli version
              run: supabase -v

            - name: Create supabase config file
              run: cp supabase/config.toml.example supabase/config.toml

            - name: Start Supabase local development setup
              run: supabase start

            - name: Verify generated types are up-to-date
              run: |
                  supabase gen types typescript --local --schema=public > types/supabase.ts
                  if [ "$(git diff --ignore-space-at-eol types/supabase.ts | wc -l)" -gt "0" ]; then
                    echo "Detected uncommitted changes after build. See status below:"
                    git diff
                    exit 1
                  fi

            - name: Run lint
              run: supabase db lint

            - name: Run tests
              run: |
                chmod +x ./supabase/db.sh
                ./supabase/db.sh db_test

    build-and-unit-test:
        runs-on: ubuntu-latest
        environment: preview

        strategy:
            matrix:
                node-version: [18.14.0]

        steps:
            - uses: actions/checkout@v3

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - run: npm ci
            - run: npm run type-check-all
            - run: npm run lint
            - run: npm run build
            - run: npm run test:run

    cypress:
        runs-on: ubuntu-22.04
        environment: preview

        strategy:
            matrix:
                node-version: [18.14.0]

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Cypress run
              uses: cypress-io/github-action@v5
              with:
                  browser: chrome
                  start: npm run dev
                  wait-on: http://localhost:3000
                  wait-on-timeout: 180
